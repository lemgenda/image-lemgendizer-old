// [Antigravity] Super-Flags for Performance
// Reduce CPU-GPU sync overhead for massive kernel counts
if (typeof env !== 'undefined') {
    env().set('WEBGPU_DEFERRED_SUBMIT_BATCH_SIZE', 1000);
}


if (isWebGPUSupported()) {
    registerBackend('webgpu', async () => {
        const gpuDescriptor = {
            powerPreference: (typeof navigator !== 'undefined' && navigator.userAgent.includes('Windows')) ?
                undefined :
                (env().get('WEBGPU_USE_LOW_POWER_GPU') ? 'low-power' : 'high-performance')
        };
        const adapter = await navigator.gpu.requestAdapter(gpuDescriptor);
        const deviceDescriptor = {};
        const requiredFeatures = [];
        if (adapter.features.has('timestamp-query')) {
            requiredFeatures.push('timestamp-query');
        }
        if (adapter.features.has('bgra8unorm-storage')) {
            requiredFeatures.push(['bgra8unorm-storage']);
        }
        deviceDescriptor.requiredFeatures = requiredFeatures;

        const adapterLimits = adapter.limits;
        deviceDescriptor.requiredLimits = {
            'maxComputeWorkgroupStorageSize': adapterLimits.maxComputeWorkgroupStorageSize,
            'maxComputeWorkgroupsPerDimension': adapterLimits.maxComputeWorkgroupsPerDimension,
            'maxStorageBufferBindingSize': adapterLimits.maxStorageBufferBindingSize,
            'maxBufferSize': adapterLimits.maxBufferSize,
            'maxComputeWorkgroupSizeX': adapterLimits.maxComputeWorkgroupSizeX,
            'maxComputeInvocationsPerWorkgroup': adapterLimits.maxComputeInvocationsPerWorkgroup,
            'maxStorageBuffersPerShaderStage': adapterLimits.maxStorageBuffersPerShaderStage,
            'maxUniformBuffersPerShaderStage': adapterLimits.maxUniformBuffersPerShaderStage,
            'maxBindGroups': adapterLimits.maxBindGroups,
            'maxUniformBufferBindingSize': adapterLimits.maxUniformBufferBindingSize
        };

        const device = await adapter.requestDevice(deviceDescriptor);
        const adapterInfo = 'info' in adapter
            ? adapter.info
            : 'requestAdapterInfo' in adapter
                // tslint:disable-next-line:no-any
                ? await adapter.requestAdapterInfo()
                : undefined;
        return new WebGPUBackend(device, adapterInfo);
    }, 3 /*priority*/);
}
// Export webgpu utilities
export * from './webgpu';

